#!/bin/sh

set -eu

FLAGS=
RETRY=

PYSTON_DEPS=$PYSTON_ROOT/../pyston_deps

if [ -f $PYSTON_DEPS/binutils-build/gold/ld-new ]; then
    LD=$PYSTON_DEPS/binutils-build/gold/ld-new
    # FLAGS="--incremental --incremental-patch=10"
    # RETRY=y
elif [ -f $PYSTON_DEPS/binutils-2.24-build/gold/ld-new ]; then
    LD=$PYSTON_DEPS/binutils-2.24-build/gold/ld-new
    # FLAGS="--incremental --incremental-patch=10"
    # RETRY=y
elif which gold > /dev/null ; then
    LD=gold
    # FLAGS="--incremental --incremental-patch=10"
    # RETRY=y
elif which ld.gold > /dev/null ; then
    LD=ld.gold
else
    echo "gold not available"
    LD=ld
fi

set +e

# echo $LD $FLAGS "$@"
$LD $FLAGS "$@"
EXIT=$?
if [ $EXIT -ne 0 -a -n "$RETRY" ]; then
    echo "retrying"
    $LD $FLAGS "$@"
    EXIT=$?
fi
exit $EXIT
